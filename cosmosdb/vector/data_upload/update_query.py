import os
from dotenv import load_dotenv
from pymongo import MongoClient
from ast import literal_eval
import pandas as pd

# Constants
IMAGE_FILE_COLUMN_NAME = "image_file"
DESCRIPTION_COLUMN_NAME = "description"
AUTHOR_COLUMN_NAME = "author"
TITLE_COLUMN_NAME = "title"
TECHNIQUE_COLUMN_NAME = "technique"
TYPE_COLUMN_NAME = "type"
TIMEFRAME_COLUMN_NAME = "timeframe"
VECTOR_COLUMN_NAME = "vector"

# Directories
current_dir = os.path.dirname(os.path.realpath(__file__))
parent_dir = os.path.dirname(current_dir)

# Load environment file
load_dotenv(os.path.join(parent_dir, ".env"), override=True)

# MongoDB credentials
mongo_host = "mongodb+srv://legorobotadmin:legorobotPassword!&@legorobot-mongo.mongocluster.cosmos.azure.com/?tls=true&authMechanism=SCRAM-SHA-256&retrywrites=false&maxIdleTimeMS=120000&tlsInsecure=true" #os.getenv("MONGO_HOST")
mongo_user = "legorobotadmin" #os.getenv("MONGO_USER")
mongo_password = "legorobotPassword!&" #os.getenv("MONGO_PASSWORD")
mongo_database_name = "legorobot" #os.getenv("MONGO_DB_NAME")
collection_name = "legoimage" #os.getenv("MONGO_COLLECTION_NAME")

# Dataset's folder
dataset_folder = os.path.join(parent_dir, "dataset")
dataset_filepath = os.path.join(dataset_folder, "dataset_embeddings.csv")


def main():
    # Connect to MongoDB
    client = MongoClient(host=mongo_host)
    db = client[mongo_database_name]
    collection = db['legoimage']

    # Define the query vector
    queryVector = [-0.079833984, 0.9614258, -0.21643066, -4.0898438, -4.9609375, -0.6074219, 2.9746094, 1.0253906, 2.3164062, 1.1582031, 0.8125, -1.7021484, 0.08807373, 1.8144531, -2.6933594, -0.9321289, -1.7890625, 1.8164062, -1.5634766, 0.41967773, -2.4648438, -1.6923828, -0.23999023, -1.7011719, 0.89453125, -0.4807129, -3.4277344, 0.42041016, -1.8007812, 4.3320312, 2.4667969, -0.32641602, 1.5683594, -1.5322266, 0.95654297, 0.7167969, -3.2265625, -0.67822266, 1.9501953, 3.6074219, -1.2949219, -3.2265625, -0.4260254, -3.8457031, 1.9541016, -1.7216797, -2.5332031, -4.3984375, -1.3681641, -2.9375, 0.75927734, -1.3242188, 0.6333008, -3.6972656, -0.20275879, 0.5810547, 1.0693359, 0.064086914, 0.47265625, -3.0878906, -0.65527344, -3.953125, -3.1425781, 2.5859375, -0.115722656, -0.32006836, -2.6738281, -3.0371094, 1.3271484, -1.5683594, 0.15576172, -5.8867188, -2.1035156, 4.4414062, 4.2734375, 4.6171875, -3.9980469, -7.0585938, -1.2275391, 1.9707031, 1.3408203, 3.875, 0.08392334, -2.0, -0.6010742, -0.12072754, -6.3632812, -6.5859375, 3.1582031, 9.296875, -2.3085938, 5.4882812, 2.5761719, 2.2402344, 2.6816406, 0.39819336, -0.39916992, -0.09069824, 1.8623047, -2.2441406, -1.1142578, 2.6582031, -1.9853516, 1.5380859, 0.48779297, 3.3671875, -0.45654297, -2.0683594, 1.1162109, 0.8095703, 2.8066406, -0.7529297, -1.5351562, -1.65625, 5.3828125, -3.0, 0.51464844, 1.3027344, -1.0517578, 2.578125, -2.9882812, -1.4462891, 0.75439453, 0.07543945, -1.8193359, 0.045715332, -1.1425781, -4.8984375, -3.2070312, 2.1035156, -5.4414062, 0.98339844, 0.030731201, -0.5205078, 0.4765625, 3.1777344, -2.0410156, 6.4765625, 2.8671875, 0.93115234, 2.3964844, -2.4003906, -0.46484375, -2.3867188, -0.39672852, -1.203125, 1.4052734, 1.25, 0.13891602, -1.90625, -0.9995117, -0.67041016, 0.53515625, -2.1601562, -2.2890625, 0.12432861, 3.0117188, 0.65771484, -2.5507812, -1.6181641, 3.0332031, -2.2382812, -1.1601562, -2.7265625, 0.41357422, -2.8671875, -3.9296875, -2.8710938, -2.8300781, 2.0605469, 1.1396484, -5.6367188, -2.6308594, -0.90722656, 3.5683594, -0.9223633, 1.0195312, 8.4375, 1.5830078, 0.27612305, 1.1728516, 0.73583984, 1.9169922, 2.921875, -3.0957031, -4.1640625, -5.5195312, -0.19360352, -2.1132812, 3.5507812, -0.09057617, -2.4335938, 2.96875, -3.8632812, -1.5957031, -3.0507812, 1.0605469, 4.4492188, 2.3574219, -1.6757812, -1.2998047, 0.40600586, -1.9833984, 1.9619141, 0.70410156, -2.6875, 2.4804688, -0.6074219, 1.1445312, -0.12194824, 1.4130859, -2.9179688, -0.5004883, 0.29467773, -21.671875, -0.08642578, 4.0117188, 2.7519531, -0.2421875, -1.3925781, -0.140625, 2.1640625, 0.14453125, 2.390625, 0.21594238, 4.1796875, -1.0673828, -1.1220703, -1.0380859, -0.91845703, -1.46875, -15.859375, -1.0498047, 0.5961914, -2.6074219, 2.3554688, -2.375, 0.69921875, 1.9853516, -1.3730469, -1.4628906, 2.4746094, 0.095947266, -1.5800781, 4.2265625, -19.3125, -0.44726562, 0.10632324, -0.93115234, 1.4609375, -2.2421875, 1.5742188, 0.6972656, -0.3017578, -0.55126953, 2.7539062, -2.0, -3.5449219, 4.1054688, 3.5292969, 1.9091797, -1.4130859, 3.0410156, -6.7578125, 1.3515625, -5.3203125, -0.8989258, -1.2871094, -0.43969727, -2.1699219, 2.8417969, -3.953125, 0.45898438, 3.109375, 5.2226562, 0.89746094, 0.44555664, -0.45092773, -0.7441406, 0.4519043, -1.4863281, -2.3359375, 1.7041016, -0.13903809, -1.7890625, 3.84375, -2.171875, -3.5, -1.4277344, -1.3085938, 2.875, -1.8066406, 1.7763672, 4.921875, -0.88134766, -3.8144531, -0.66015625, 3.4980469, 2.0429688, -0.79345703, 2.0351562, 3.2109375, -0.46484375, 0.4091797, -0.88916016, 0.10119629, -1.2871094, 1.0908203, 1.0791016, -1.2441406, 0.92578125, -2.2539062, 0.04748535, 0.34277344, -2.125, -0.62060547, -0.25634766, -1.1894531, -0.94873047, -0.5024414, 1.8427734, 1.7294922, -1.3076172, 2.1914062, 1.9501953, 0.65722656, -1.9990234, -1.3789062, -0.828125, 18.3125, 0.23425293, -1.8193359, 0.92578125, -3.3671875, 1.2861328, 8.640625, 0.45996094, -3.5898438, 1.8847656, 1.3212891, -0.42773438, -0.5522461, 1.0634766, 0.5864258, 0.45092773, 1.0175781, 0.64990234, 0.85546875, -0.23669434, 0.06866455, -0.73291016, 0.8432617, 0.38964844, -2.125, 3.3222656, -0.36865234, 2.0664062, 2.6816406, -4.8789062, -0.07702637, 0.9916992, 2.5664062, 1.7617188, -1.2636719, -0.06555176, 3.734375, -1.2724609, -0.2076416, -2.4609375, -0.79052734, 2.1933594, 2.4296875, 0.8491211, -0.42041016, 0.6850586, -0.7675781, 2.1777344, -0.59765625, -0.85839844, 2.9746094, 0.5805664, -2.4980469, -3.1875, 2.6074219, -0.12121582, -1.2021484, -2.0859375, -0.9145508, -0.03353882, 4.140625, -1.7402344, -0.2775879, -2.0136719, 0.43164062, 0.17077637, 5.1132812, -0.40625, -0.66845703, -5.8476562, -0.33251953, 0.83984375, -0.6826172, 0.41479492, 0.6425781, -1.0322266, -1.5839844, 5.6328125, -0.099609375, 1.0390625, -3.8183594, 3.3222656, -1.0488281, -0.35131836, 0.63623047, 2.5683594, -0.4501953, 2.0605469, 0.4284668, -2.8496094, 1.9892578, 3.8261719, 0.77441406, -0.7548828, -1.0546875, 2.2226562, -27.265625, 3.1074219, 1.7246094, -1.8623047, -0.5683594, -2.1894531, 2.9414062, 0.03955078, -3.8144531, 1.0371094, -2.7617188, 2.90625, -0.35839844, -1.9267578, 0.7416992, 2.4101562, 0.27685547, -0.5395508, -0.8955078, 1.4912109, 1.5234375, 1.6025391, -2.9296875, 2.1699219, 0.1083374, -0.4724121, -4.25, 0.73876953, -1.3710938, -5.4921875, -2.7363281, 0.042663574, 1.4833984, 4.7148438, -1.5439453, -0.6586914, 0.3371582, 2.5507812, 11.59375, 0.9580078, -2.1992188, -1.65625, -4.3085938, -6.3046875, 1.4208984, 1.0761719, -0.7729492, 3.5292969, 2.5214844, 3.6894531, 0.43798828, 1.3964844, 1.1875, -1.7138672, -6.1289062, -0.19519043, 1.9384766, -2.2734375, -2.3632812, -5.3632812, -1.0634766, -0.50390625, 3.1210938, 3.5625, -3.3632812, -2.1367188, -2.0507812, 0.108947754, -0.060394287, 0.21484375, 2.2304688, -0.7919922, -0.33642578, -0.7729492, 4.1015625, 4.6679688, 1.2119141, 7.9179688, -0.035064697, -1.0097656, -0.0008125305, 3.7597656, 1.0742188, 2.7714844, 1.7841797, -1.1679688, -2.6464844, 0.40771484, 1.203125, -2.6308594, -0.3798828, -0.29467773, 2.8691406, -0.74365234, -1.2128906, -2.4101562, 0.9272461, 2.3847656, 0.030197144, 6.8085938, -0.61328125, 0.3125, -1.4453125, -3.6601562, 0.18603516, -0.99658203, -0.54003906, -2.2578125, 2.09375, 1.9570312, 0.12261963, 1.2519531, 1.8261719, 0.9057617, 0.27197266, -0.4375, -1.2978516, -2.1835938, 3.0976562, -1.4462891, -3.5898438, -4.8085938, -3.5058594, 0.5205078, -0.5727539, 1.7724609, 0.2685547, 2.8359375, -0.113342285, 2.1308594, 0.39990234, -0.5083008, 1.0644531, -4.59375, -0.83984375, 0.29736328, 2.0605469, 0.008407593, -4.0078125, 0.24157715, 0.08276367, 1.7529297, 0.8417969, 0.06640625, -3.2773438, -3.5507812, 1.7304688, 1.7333984, 7.2421875, 2.0898438, -0.9785156, 1.4091797, 1.1025391, -2.1660156, -3.6972656, -2.875, 1.5908203, 2.8496094, -0.37158203, 0.89453125, -1.4257812, 1.359375, 2.4257812, 2.8632812, -5.5, 1.0595703, -1.7744141, 1.9765625, 2.0332031, -1.6152344, -4.4765625, -0.002910614, 1.1777344, -3.8769531, -0.8256836, -0.5673828, -2.9921875, -1.9169922, 1.6308594, -1.5410156, 1.5283203, 2.1367188, 1.9833984, 4.34375, -1.1269531, 1.8330078, 2.6621094, -0.39013672, -0.037872314, 2.6582031, 4.078125, -0.0703125, 1.2363281, 0.25805664, 0.55908203, 1.4257812, 1.2617188, 1.5712891, -0.16320801, 2.3066406, -0.1583252, 1.0429688, 5.2265625, -0.8828125, -0.96728516, -1.9101562, 0.037872314, 3.4277344, -2.9550781, -1.7060547, 2.515625, 1.5908203, -0.32250977, 1.2783203, 0.25732422, 1.0429688, 2.265625, -2.2890625, -2.921875, 0.5595703, -0.57128906, -7.0898438, -0.6699219, -0.18591309, 1.7666016, -0.84765625, 0.59228516, 2.2363281, 3.5449219, 1.8261719, 3.5761719, 1.3789062, -3.2382812, -1.1162109, -1.1201172, 0.25146484, 3.4277344, -2.625, 0.19311523, -1.2050781, -0.053894043, -2.3808594, 3.2675781, -1.6757812, -0.43530273, -0.97216797, 0.5395508, 3.1210938, 1.3701172, -2.4746094, 2.484375, -2.7363281, 1.8681641, -3.5136719, 4.7578125, 1.5195312, -1.9892578, 3.0214844, 3.6269531, -2.6289062, -0.8935547, 0.64746094, -1.6503906, -1.8037109, 1.796875, 1.3066406, -2.9101562, 2.8496094, -0.40551758, -1.2802734, 1.6113281, 2.1738281, 2.90625, -1.90625, 0.29125977, -3.8066406, 5.0, 1.9707031, 1.3291016, -6.6445312, -2.2363281, 1.7871094, -0.85302734, 0.36450195, 0.82958984, -6.1445312, 4.2304688, -0.19750977, -0.50390625, 1.4492188, -1.5576172, -1.8203125, -0.6118164, -1.9482422, 2.53125, -1.4160156, 2.5664062, -0.9248047, -2.4121094, -1.3974609, 5.3398438, -0.8652344, -1.296875, -2.5429688, -7.7265625, 0.7915039, 4.8007812, -0.88623047, 0.93847656, 5.5820312, 8.578125, -2.7421875, 2.8105469, -2.1386719, -3.5625, 3.578125, -0.9296875, -0.059143066, -7.4296875, -3.8339844, 0.61816406, -1.1445312, -1.0136719, -0.45898438, 0.36938477, -0.62646484, 1.5380859, -1.1572266, -0.024856567, -0.9213867, -1.2158203, 2.1425781, 1.8847656, -0.30615234, -2.6347656, -2.0488281, -2.578125, -3.5371094, -1.5908203, 1.1074219, 1.2382812, 0.6401367, 0.99365234, 4.328125, -0.14135742, -1.6884766, -3.2226562, 1.0703125, -1.7246094, -7.2773438, -1.9228516, 2.6855469, -5.28125, 0.82177734, 3.0878906, 0.07928467, -0.64990234, 7.7382812, -0.57421875, -2.3183594, -0.36572266, 0.34692383, 1.7763672, 0.11608887, -4.1367188, 0.11029053, -3.7929688, -2.3339844, 1.9736328, -0.30908203, 2.3691406, -1.2158203, 1.7919922, 2.5664062, 2.7382812, -3.3671875, 1.3203125, 2.8105469, 4.2929688, -2.8066406, 0.50341797, 0.4230957, 4.5234375, 2.7050781, -9.0859375, 0.19580078, 0.2944336, -1.1503906, -2.9375, 6.4101562, -1.4550781, 2.2109375, 1.0419922, 1.3935547, 4.5351562, -0.12524414, -1.4208984, -2.8789062, 2.1523438, 0.33862305, 2.9941406, 0.21704102, -3.1035156, 5.3984375, -1.7265625, 1.2685547, -2.7265625, -2.1132812, -1.4287109, 2.8125, -3.4101562, 2.8730469, 1.9833984, 0.30810547, -1.8876953, 1.9892578, -2.5371094, -2.6210938, -0.12890625, 0.92578125, 0.9584961, -1.5410156, -1.9550781, -2.1601562, -1.7978516, -1.7617188, 0.7128906, -5.0117188, -0.9785156, -0.62597656, -1.4492188, 1.5634766, -1.3330078, 0.03604126, 0.9926758, 0.91015625, 2.4179688, -1.8261719, 3.5566406, -1.5761719, 5.53125, 1.8867188, 0.45361328, 0.82958984, 0.20239258, 3.1113281, 1.5390625, 5.671875, -0.76123047, -1.6992188, 0.9453125, 0.13146973, -2.6542969, -0.4375, -0.9824219, -2.3144531, -5.9921875, -0.8041992, -0.8027344, 4.2578125, 0.18078613, -1.2363281, 1.1708984, 0.19104004, -1.78125, -2.4433594, 0.95751953, 0.9423828, 1.3037109, 1.4306641, -1.4404297, 3.0839844, -1.8623047, 1.7246094, 0.024429321, -1.0546875, -4.7695312, -0.90185547, 0.5214844, -1.8046875, 4.3320312, 4.4648438, 3.2265625, -1.875, -0.59375, -5.4609375, -2.21875, 2.078125, -1.2597656, -3.5390625, 0.27368164, -0.44921875, 1.4902344, -4.1132812, -2.3730469, 3.1992188, 0.8876953, -1.8203125, -1.0703125, 2.8457031, -0.46704102, 3.9101562, -1.6894531, 1.1083984, 0.6489258, -1.7431641, 1.5185547, -3.0136719, -6.0117188, -2.2851562, 4.1601562, -1.203125, 1.2861328, 0.31103516, -2.921875, -2.9960938, -1.4775391, 1.0625, -1.1123047, 2.0449219, 0.41845703, -0.46435547, 1.7558594, 1.6308594, 0.87939453, -1.2675781, -0.6147461, 2.1914062, -2.640625, 1.9667969, -7.2578125, 5.0507812, 3.0410156, -2.2050781, 2.1132812, 1.3378906, -2.1484375, -1.3085938, 0.13085938, 1.1328125, -1.2246094, 0.9296875, -3.6679688, -0.1459961, -0.6459961, 0.7080078, 0.54541016, 3.734375, -1.8261719, -0.8911133, -0.77197266, -0.17565918, -0.84814453, -0.26220703, 2.640625, 0.3564453, -0.13903809, -2.9257812, 2.1796875, -0.34985352, 0.30249023, -1.0576172, 2.5625, 2.5488281, -2.2148438, 0.21362305, 1.7011719, 2.8457031, -1.7207031, 4.3085938, 5.2226562, 3.7949219, 1.6152344, -0.081848145, 2.3945312, 2.2851562, -1.3681641, -1.8447266, 2.6464844, -0.7963867, 0.18701172, 2.9101562, -3.8652344, 5.734375, 3.1035156, 1.3632812, 2.0097656, -3.0019531, -0.7729492, -2.0097656, 0.40405273, 1.0917969, -0.91845703, -0.12585449, 0.3076172, 3.9980469, -0.45581055, 3.8574219, -0.62597656]

    # Define the aggregate query
    query = [
        {
            "$search": {
                "cosmosSearch": {
                    "vector": queryVector,
                    "path": "vectorContent",
                    "k": 3
                },
                "returnStoredSource": True
            }
        }
    ]

    # Execute the aggregate query
    results = collection.aggregate(query)

    # Print the results
    for result in results:
        print(result)

        
    # print("Saving data to MongoDB...")
    # from ast import literal_eval
    # data = pd.read_csv(dataset_filepath,index_col=False,sep='\t')
    # #data = data.drop('Unnamed: 0', axis=1)
    # data.vector = data.vector.apply(literal_eval)

    # for i in range(len(data)):
    #     doc_to_upload = data.loc[i].to_dict()
    #     collection.insert_one(doc_to_upload)
        
    # #print("Document", i , "inserted successfully.")

    # # Fetch all documents from collection
    # num_records = collection.count_documents({})
    # print(f"Number of records in the collection: {num_records}")

    # db.command({
    #     'createIndexes': 'legoimage',
    #     'indexes': [
    #         {
    #         'name': 'vsearch_image',
    #         'key': {
    #             "vector": "cosmosSearch"
    #         },
    #         'cosmosSearchOptions': {
    #             'kind': 'vector-ivf',
    #             'numLists': 800,
    #             'similarity': 'COS',
    #             'dimensions': 1024
    #         }
    #         }
    #     ]
    #     })


    print("Done!")

if __name__ == "__main__":
    main()

